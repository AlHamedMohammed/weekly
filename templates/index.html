<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ISO 9001 Quality Assistant</title>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow:ital,wght@0,300;0,400;0,500;0,600;1,400&family=Barlow+Condensed:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       VARIABLES & RESET
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    :root {
      --bg:          #0b0f15;
      --bg2:         #141920;
      --bg3:         #1a2030;
      --bg4:         #1f2738;
      --border:      #252e3d;
      --border-glow: #00d4aa35;
      --cyan:        #00d4aa;
      --cyan-dim:    #00d4aa70;
      --cyan-pale:   #00d4aa14;
      --cyan-bright: #00ffcc;
      --amber:       #f5a623;
      --red:         #ef4444;
      --green:       #22c55e;
      --text:        #c8d3e0;
      --text-dim:    #5a6a7e;
      --text-bright: #e4ecf5;
      --sidebar-w:   260px;
      --mono:        'Share Tech Mono', monospace;
      --sans:        'Barlow', sans-serif;
      --cond:        'Barlow Condensed', sans-serif;
      --radius:      6px;
      --tr:          0.18s cubic-bezier(0.4,0,0.2,1);
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html, body { height: 100%; overflow: hidden; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--sans);
      font-size: 14px;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    /* Grid background */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      background-image:
        linear-gradient(var(--border) 1px, transparent 1px),
        linear-gradient(90deg, var(--border) 1px, transparent 1px);
      background-size: 44px 44px;
      opacity: 0.18;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       APP SHELL  (sidebar + main)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .shell {
      position: relative;
      z-index: 1;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SIDEBAR
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .sidebar {
      width: var(--sidebar-w);
      flex-shrink: 0;
      background: var(--bg2);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      height: 100vh;
      transition: transform var(--tr);
      z-index: 10;
    }

    .sidebar-head {
      padding: 16px 14px 12px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .brand-tag {
      font-family: var(--mono);
      font-size: 9px;
      color: var(--cyan);
      letter-spacing: 0.22em;
      text-transform: uppercase;
      margin-bottom: 3px;
    }

    .brand-name {
      font-family: var(--cond);
      font-size: 18px;
      font-weight: 700;
      color: var(--text-bright);
      letter-spacing: 0.04em;
      line-height: 1;
    }

    .brand-name span { color: var(--cyan); }

    .btn-new-chat {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      margin-top: 12px;
      padding: 9px 12px;
      background: var(--cyan-pale);
      border: 1px solid var(--border-glow);
      border-radius: var(--radius);
      color: var(--cyan);
      font-family: var(--cond);
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      cursor: pointer;
      transition: all var(--tr);
    }

    .btn-new-chat:hover {
      background: var(--cyan);
      color: #0a0f14;
      box-shadow: 0 0 18px var(--cyan-dim);
      border-color: var(--cyan);
    }

    .btn-new-chat svg { width: 13px; height: 13px; flex-shrink: 0; }

    /* Conversation list */
    .conv-section-label {
      padding: 14px 14px 6px;
      font-family: var(--mono);
      font-size: 9px;
      color: var(--text-dim);
      letter-spacing: 0.2em;
      text-transform: uppercase;
      flex-shrink: 0;
    }

    .conv-list {
      flex: 1;
      overflow-y: auto;
      padding: 0 8px 12px;
    }

    .conv-list::-webkit-scrollbar { width: 3px; }
    .conv-list::-webkit-scrollbar-track { background: transparent; }
    .conv-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    .conv-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 9px 8px;
      border-radius: 5px;
      cursor: pointer;
      transition: background var(--tr);
      position: relative;
    }

    .conv-item:hover { background: var(--bg3); }

    .conv-item.active {
      background: var(--bg4);
      border: 1px solid var(--border);
    }

    .conv-item.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 20%;
      height: 60%;
      width: 2px;
      background: var(--cyan);
      border-radius: 0 2px 2px 0;
    }

    .conv-icon {
      font-size: 13px;
      flex-shrink: 0;
      opacity: 0.7;
    }

    .conv-text {
      flex: 1;
      min-width: 0;
    }

    .conv-title {
      font-family: var(--sans);
      font-size: 12px;
      font-weight: 500;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.3;
    }

    .conv-item.active .conv-title { color: var(--text-bright); }

    .conv-meta {
      font-family: var(--mono);
      font-size: 9px;
      color: var(--text-dim);
      margin-top: 2px;
    }

    .conv-del {
      opacity: 0;
      transition: opacity var(--tr);
      background: none;
      border: none;
      color: var(--text-dim);
      cursor: pointer;
      font-size: 13px;
      padding: 2px 4px;
      border-radius: 3px;
      flex-shrink: 0;
    }

    .conv-item:hover .conv-del { opacity: 1; }
    .conv-del:hover { color: var(--red); background: #ef444420; }

    /* Empty state */
    .conv-empty {
      padding: 20px 14px;
      text-align: center;
      font-family: var(--mono);
      font-size: 10px;
      color: var(--text-dim);
      line-height: 1.8;
    }

    /* Sidebar footer */
    .sidebar-foot {
      padding: 10px 14px;
      border-top: 1px solid var(--border);
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sidebar-foot-txt {
      font-family: var(--mono);
      font-size: 9px;
      color: var(--text-dim);
      letter-spacing: 0.1em;
      flex: 1;
    }

    .dot-live {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--green);
      animation: pulse-dot 2s ease-in-out infinite;
      flex-shrink: 0;
    }

    @keyframes pulse-dot {
      0%, 100% { opacity: 1; }
      50%       { opacity: 0.4; }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MAIN AREA
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      min-width: 0;
    }

    /* Top bar */
    .topbar {
      flex-shrink: 0;
      padding: 12px 20px;
      border-bottom: 1px solid var(--border);
      background: var(--bg2);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .sidebar-toggle {
      display: none;
      background: none;
      border: 1px solid var(--border);
      color: var(--text-dim);
      border-radius: var(--radius);
      padding: 6px 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all var(--tr);
    }

    .sidebar-toggle:hover {
      border-color: var(--cyan-dim);
      color: var(--cyan);
    }

    .topbar-title {
      font-family: var(--cond);
      font-size: 14px;
      font-weight: 600;
      color: var(--text-bright);
      letter-spacing: 0.06em;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .topbar-pills {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-shrink: 0;
    }

    .pill {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 3px 9px;
      border-radius: 20px;
      font-family: var(--mono);
      font-size: 9px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      border: 1px solid;
    }

    .pill-doc {
      color: var(--cyan);
      border-color: var(--border-glow);
      background: var(--cyan-pale);
      cursor: pointer;
    }

    .pill-doc:hover { border-color: var(--cyan-dim); }
    .pill-doc.hidden { display: none; }

    .pill-model {
      color: var(--text-dim);
      border-color: var(--border);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CHAT MESSAGES
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .chat-body {
      flex: 1;
      overflow-y: auto;
      padding: 24px 20px;
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .chat-body::-webkit-scrollbar { width: 4px; }
    .chat-body::-webkit-scrollbar-track { background: transparent; }
    .chat-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
    .chat-body::-webkit-scrollbar-thumb:hover { background: var(--cyan-dim); }

    /* Welcome screen */
    .welcome {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 40px 20px;
      gap: 14px;
    }

    .welcome-icon {
      font-size: 36px;
      margin-bottom: 4px;
      opacity: 0.8;
    }

    .welcome-title {
      font-family: var(--cond);
      font-size: 24px;
      font-weight: 700;
      color: var(--text-bright);
      letter-spacing: 0.04em;
    }

    .welcome-title span { color: var(--cyan); }

    .welcome-sub {
      font-size: 13px;
      color: var(--text-dim);
      max-width: 400px;
      line-height: 1.7;
    }

    .suggestion-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      max-width: 480px;
      width: 100%;
      margin-top: 8px;
    }

    .suggestion {
      padding: 10px 14px;
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 11.5px;
      color: var(--text-dim);
      cursor: pointer;
      text-align: left;
      line-height: 1.5;
      transition: all var(--tr);
    }

    .suggestion:hover {
      border-color: var(--cyan-dim);
      color: var(--text);
      background: var(--bg4);
    }

    .suggestion strong {
      display: block;
      color: var(--cyan);
      font-family: var(--mono);
      font-size: 9px;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    /* Message bubbles */
    .msg-group {
      display: flex;
      flex-direction: column;
      gap: 2px;
      margin-bottom: 20px;
      animation: fadeUp 0.25s ease both;
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .msg-row {
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }

    .msg-row.user { flex-direction: row-reverse; }

    .msg-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
      font-family: var(--mono);
      margin-top: 2px;
    }

    .msg-avatar.bot {
      background: var(--cyan-pale);
      border: 1px solid var(--border-glow);
      color: var(--cyan);
    }

    .msg-avatar.user {
      background: var(--bg4);
      border: 1px solid var(--border);
      color: var(--text-dim);
    }

    .msg-content {
      max-width: 72%;
      min-width: 60px;
    }

    .msg-row.user .msg-content { align-items: flex-end; display: flex; flex-direction: column; }

    .msg-bubble {
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 14px;
      line-height: 1.75;
      word-break: break-word;
      white-space: pre-wrap;
    }

    .msg-row.bot .msg-bubble {
      background: var(--bg3);
      border: 1px solid var(--border);
      border-top-left-radius: 2px;
      color: var(--text);
    }

    .msg-row.user .msg-bubble {
      background: var(--bg4);
      border: 1px solid var(--border);
      border-top-right-radius: 2px;
      color: var(--text-bright);
    }

    .msg-row.bot .msg-bubble strong,
    .msg-row.bot .msg-bubble b { color: var(--cyan); font-weight: 600; }

    .msg-bubble .clause {
      display: inline-block;
      background: var(--cyan-pale);
      border: 1px solid var(--border-glow);
      color: var(--cyan);
      font-family: var(--mono);
      font-size: 10px;
      padding: 1px 5px;
      border-radius: 3px;
      margin: 0 2px;
    }

    .msg-time {
      font-family: var(--mono);
      font-size: 9px;
      color: var(--text-dim);
      margin-top: 4px;
      padding: 0 4px;
    }

    /* Thinking indicator */
    .thinking-bubble {
      background: var(--bg3);
      border: 1px solid var(--border);
      border-top-left-radius: 2px;
      padding: 12px 16px;
      border-radius: 10px;
      display: flex;
      gap: 5px;
      align-items: center;
    }

    .thinking-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--cyan-dim);
      animation: think 1.4s ease-in-out infinite;
    }

    .thinking-dot:nth-child(2) { animation-delay: 0.2s; }
    .thinking-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes think {
      0%, 80%, 100% { transform: scale(0.7); opacity: 0.4; }
      40%            { transform: scale(1);   opacity: 1; }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       INPUT BAR
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .input-area {
      flex-shrink: 0;
      padding: 12px 20px 16px;
      background: var(--bg2);
      border-top: 1px solid var(--border);
    }

    /* Context strip */
    .ctx-strip {
      display: none;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      margin-bottom: 8px;
      background: var(--cyan-pale);
      border: 1px solid var(--border-glow);
      border-radius: 4px;
      font-family: var(--mono);
      font-size: 9px;
      color: var(--cyan);
    }

    .ctx-strip.show { display: flex; }

    .ctx-strip-remove {
      margin-left: auto;
      cursor: pointer;
      color: var(--text-dim);
      font-size: 12px;
      transition: color var(--tr);
    }

    .ctx-strip-remove:hover { color: var(--red); }

    /* Upload row */
    .upload-quick {
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
    }

    .upload-pill {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 5px 10px;
      background: var(--bg3);
      border: 1px dashed var(--border);
      border-radius: 4px;
      font-family: var(--mono);
      font-size: 9px;
      color: var(--text-dim);
      cursor: pointer;
      transition: all var(--tr);
      position: relative;
      overflow: hidden;
    }

    .upload-pill:hover {
      border-color: var(--cyan-dim);
      color: var(--cyan);
    }

    .upload-pill.loaded {
      border-style: solid;
      border-color: var(--cyan-dim);
      color: var(--cyan);
    }

    .upload-pill input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    /* Main input box */
    .input-box {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 8px 8px 14px;
      transition: border-color var(--tr), box-shadow var(--tr);
    }

    .input-box:focus-within {
      border-color: var(--cyan-dim);
      box-shadow: 0 0 0 1px var(--cyan-pale);
    }

    .input-box textarea {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      resize: none;
      color: var(--text-bright);
      font-family: var(--sans);
      font-size: 14px;
      line-height: 1.6;
      caret-color: var(--cyan);
      min-height: 22px;
      max-height: 180px;
      overflow-y: auto;
    }

    .input-box textarea::placeholder { color: var(--text-dim); }

    .input-box textarea::-webkit-scrollbar { width: 3px; }
    .input-box textarea::-webkit-scrollbar-thumb { background: var(--border); }

    .input-actions {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
    }

    .btn-send {
      width: 34px;
      height: 34px;
      border-radius: 8px;
      background: var(--cyan);
      border: none;
      color: #0a0f14;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--tr);
      flex-shrink: 0;
    }

    .btn-send:hover {
      background: var(--cyan-bright);
      box-shadow: 0 0 16px var(--cyan-dim);
    }

    .btn-send:disabled {
      opacity: 0.35;
      cursor: not-allowed;
      pointer-events: none;
    }

    .btn-send svg { width: 16px; height: 16px; }

    .btn-send.loading {
      pointer-events: none;
    }

    .btn-send.loading svg { display: none; }

    .btn-send .spin {
      display: none;
      width: 14px;
      height: 14px;
      border: 2px solid transparent;
      border-top-color: #0a0f14;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }

    .btn-send.loading .spin { display: block; }

    @keyframes spin { to { transform: rotate(360deg); } }

    .input-hint {
      text-align: center;
      font-family: var(--mono);
      font-size: 9px;
      color: var(--text-dim);
      margin-top: 6px;
      letter-spacing: 0.08em;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TOAST
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--bg3);
      border: 1px solid var(--cyan-dim);
      border-radius: var(--radius);
      padding: 10px 14px;
      font-family: var(--mono);
      font-size: 10px;
      color: var(--cyan);
      z-index: 999;
      transform: translateY(60px);
      opacity: 0;
      transition: all 0.28s cubic-bezier(0.34, 1.56, 0.64, 1);
      max-width: 260px;
    }

    .toast.show { transform: translateY(0); opacity: 1; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PROCESSING BAR (top of page)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .proc-bar {
      position: fixed;
      top: 0; left: 0; right: 0;
      height: 2px;
      background: transparent;
      z-index: 200;
      overflow: hidden;
      display: none;
    }

    .proc-bar.show { display: block; }

    .proc-bar::after {
      content: '';
      display: block;
      height: 100%;
      width: 35%;
      background: linear-gradient(90deg, transparent, var(--cyan), transparent);
      animation: scan 1.1s ease-in-out infinite;
    }

    @keyframes scan {
      0%   { transform: translateX(-100%); }
      100% { transform: translateX(400%); }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RESPONSIVE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    @media (max-width: 700px) {
      :root { --sidebar-w: 240px; }

      .sidebar {
        position: fixed;
        top: 0; left: 0; bottom: 0;
        transform: translateX(-100%);
        box-shadow: 4px 0 24px #00000060;
      }

      .sidebar.open { transform: translateX(0); }

      .sidebar-toggle { display: flex; }

      .suggestion-grid { grid-template-columns: 1fr; }
      .msg-content { max-width: 85%; }
    }

    /* Sidebar overlay on mobile */
    .sidebar-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: #00000060;
      z-index: 9;
    }

    .sidebar-overlay.show { display: block; }
  </style>
</head>
<body>

<div class="proc-bar" id="procBar"></div>
<div class="toast" id="toast"></div>
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<div class="shell">

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SIDEBAR
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-head">
      <div class="brand-tag">// QMS Advisory</div>
      <div class="brand-name">ISO 9001 <span>AI</span></div>
      <button class="btn-new-chat" id="newChatBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
        New Conversation
      </button>
    </div>

    <div class="conv-section-label">Conversations</div>

    <div class="conv-list" id="convList">
      <div class="conv-empty" id="convEmpty">
        No conversations yet.<br/>Start asking questions below.
      </div>
    </div>

    <div class="sidebar-foot">
      <span class="dot-live"></span>
      <span class="sidebar-foot-txt">CONNECTED Â· GPT-5.2</span>
    </div>
  </aside>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MAIN
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="main">

    <!-- Top bar -->
    <div class="topbar">
      <button class="sidebar-toggle" id="sidebarToggle">â˜°</button>
      <div class="topbar-title" id="topbarTitle">ISO 9001 Quality Assistant</div>
      <div class="topbar-pills">
        <div class="pill pill-doc hidden" id="docPill">
          <span>ğŸ“</span>
          <span id="docPillLabel">doc.pdf</span>
          <span style="cursor:pointer;margin-left:2px" id="docPillRemove">âœ•</span>
        </div>
        <div class="pill pill-model">GPT-5.2</div>
      </div>
    </div>

    <!-- Chat body -->
    <div class="chat-body" id="chatBody">

      <!-- Welcome screen (shown when no messages) -->
      <div class="welcome" id="welcomeScreen">
        <div class="welcome-icon">âš™ï¸</div>
        <div class="welcome-title">ISO 9001 <span>Assistant</span></div>
        <div class="welcome-sub">Senior Quality Management advisor. Ask about clauses, audits, CAPA, risk-based thinking, or upload documents for analysis.</div>
        <div class="suggestion-grid">
          <div class="suggestion" onclick="sendSuggestion(this)">
            <strong>Audit</strong>
            How do I prepare for an ISO 9001 internal audit?
          </div>
          <div class="suggestion" onclick="sendSuggestion(this)">
            <strong>CAPA</strong>
            Walk me through writing an effective corrective action.
          </div>
          <div class="suggestion" onclick="sendSuggestion(this)">
            <strong>Clause 6.1</strong>
            How should we address risks and opportunities in our QMS?
          </div>
          <div class="suggestion" onclick="sendSuggestion(this)">
            <strong>PDCA</strong>
            Explain the Plan-Do-Check-Act cycle with examples.
          </div>
        </div>
      </div>

    </div>

    <!-- Input area -->
    <div class="input-area">

      <!-- Context strip -->
      <div class="ctx-strip" id="ctxStrip">
        <span>ğŸ“</span>
        <span id="ctxStripLabel">No document</span>
        <span class="ctx-strip-remove" id="ctxStripRemove">âœ•</span>
      </div>

      <!-- Quick uploads -->
      <div class="upload-quick">
        <label class="upload-pill" id="docUploadPill">
          <span>ğŸ“„</span>
          <span id="docUploadLabel">Attach Document</span>
          <input type="file" id="docUploadInput" accept=".pdf,.docx,.txt" />
        </label>
      </div>

      <!-- Main input -->
      <div class="input-box">
        <textarea
          id="msgInput"
          rows="1"
          placeholder="Ask about ISO 9001, audits, CAPA, risk managementâ€¦"
        ></textarea>
        <div class="input-actions">
          <button class="btn-send" id="sendBtn">
            <div class="spin"></div>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="22" y1="2" x2="11" y2="13"/>
              <polygon points="22 2 15 22 11 13 2 9 22 2"/>
            </svg>
          </button>
        </div>
      </div>

      <div class="input-hint">Enter to send Â· Shift+Enter for new line</div>
    </div>

  </div><!-- /main -->
</div><!-- /shell -->

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPER FUNCTIONS (defined first for clarity)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function escHtml(str) {
  return str.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

function formatTime(date) {
  return date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
}

function formatRelTime(date) {
  const now  = new Date();
  const diff = Math.floor((now - date) / 1000);
  if (diff < 60)   return "just now";
  if (diff < 3600) return Math.floor(diff / 60) + "m ago";
  if (diff < 86400) return Math.floor(diff / 3600) + "h ago";
  return date.toLocaleDateString();
}

function showToast(msg, dur = 3000) {
  clearTimeout(toastTimer);
  toast.textContent = msg;
  toast.classList.add("show");
  toastTimer = setTimeout(() => toast.classList.remove("show"), dur);
}

function scrollToBottom() {
  requestAnimationFrame(() => {
    chatBody.scrollTop = chatBody.scrollHeight;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CONFIG = {
  API_BASE: "http://localhost:5000",
};

const SYSTEM_PROMPT = `You are a Senior Quality Management Expert with comprehensive expertise in ISO 9001:2015, industry-specific quality standards (e.g., IATF 16949, AS9100D, ISO 13485), and proven best practices in Quality Management Systems (QMS).

ROLE & RESPONSIBILITIES:
â€¢ Act as a strategic advisor, internal/external auditor, and implementation consultant
â€¢ Provide authoritative guidance on ISO 9001 clause interpretation, compliance strategies, and certification readiness
â€¢ Analyze quality processes, identify gaps, and recommend evidence-based improvements
â€¢ Support CAPA effectiveness, risk-based decision making, and continuous improvement initiatives

CORE COMPETENCIES:
- ISO 9001:2015 clause structure and application
- Process approach and PDCA methodology
- Risk management (ISO 31000 principles)
- Quality documentation hierarchy (Quality Manual, Procedures, Work Instructions, Records)
- Audit execution and non-conformance management
- Performance evaluation and KPI development

RESPONSE PROTOCOLS:

1. STRUCTURE & FORMAT
   â€¢ Begin with a concise summary of the key issue
   â€¢ Use hierarchical headings (H1, H2) for multi-topic responses
   â€¢ Employ tables for comparative analysis (e.g., clause requirements vs. current state)
   â€¢ Format lists with clear numbering or bullet points
   â€¢ End with actionable next steps or recommendations

2. CONTENT QUALITY
   â€¢ Reference specific ISO 9001 clauses (e.g., "Clause 7.5.3.2 requires...")
   â€¢ Provide real-world examples or scenarios to illustrate concepts
   â€¢ Include implementation tips and common pitfalls to avoid
   â€¢ Suggest relevant documentation or evidence requirements
   â€¢ Recommend industry-specific adaptations when applicable

3. PROFESSIONAL STANDARDS
   â€¢ Maintain an authoritative yet approachable consultative tone
   â€¢ Use quality management terminology accurately and consistently
   â€¢ Acknowledge alternative approaches when multiple valid options exist
   â€¢ Clearly indicate when regulatory requirements supersede guidance
   â€¢ Avoid ambiguous statements or unfounded assumptions

4. HANDLING UNCERTAINTY
   â€¢ If information is incomplete, state: "Based on available information..."
   â€¢ When data is insufficient, specify: "Additional details needed: [list specific information required]"
   â€¢ If the query falls outside expertise, respond: "This requires specialized knowledge beyond ISO 9001. Recommend consulting with [relevant specialist/authority]"

5. QUALITY ASSURANCE
   â€¢ Verify all guidance aligns with current ISO 9001:2015 requirements
   â€¢ Cross-reference related clauses when addressing complex topics
   â€¢ Flag potential contradictions or conflicts in requirements
   â€¢ Distinguish between mandatory requirements and optional best practices

RESPONSE TEMPLATE PREFERENCE:
â€¢ For clause interpretation: Clause â†’ Requirement â†’ Practical Application â†’ Evidence Required
â€¢ For problem-solving: Issue â†’ Root Cause Analysis â†’ Corrective Actions â†’ Preventive Measures
â€¢ For audit preparation: Scope â†’ Criteria â†’ Evidence to Review â†’ Common Findings â†’ Improvement Opportunities

Always think like an experienced Lead Auditor evaluating organizational readiness, identifying both strengths and opportunities for improvement.`;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let conversations   = [];   // [{id, title, messages:[{role,content,time}]}]
let activeConvId    = null;
let documentContext = "";
let documentName    = "";
let isLoading       = false;
let toastTimer;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DOM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const convList        = document.getElementById("convList");
const convEmpty       = document.getElementById("convEmpty");
const newChatBtn      = document.getElementById("newChatBtn");
const chatBody        = document.getElementById("chatBody");
const welcomeScreen   = document.getElementById("welcomeScreen");
const msgInput        = document.getElementById("msgInput");
const sendBtn         = document.getElementById("sendBtn");
const topbarTitle     = document.getElementById("topbarTitle");
const docPill         = document.getElementById("docPill");
const docPillLabel    = document.getElementById("docPillLabel");
const docPillRemove   = document.getElementById("docPillRemove");
const ctxStrip        = document.getElementById("ctxStrip");
const ctxStripLabel   = document.getElementById("ctxStripLabel");
const ctxStripRemove  = document.getElementById("ctxStripRemove");
const docUploadInput  = document.getElementById("docUploadInput");
const docUploadLabel  = document.getElementById("docUploadLabel");
const docUploadPill   = document.getElementById("docUploadPill");
const procBar         = document.getElementById("procBar");
const toast           = document.getElementById("toast");
const sidebar         = document.getElementById("sidebar");
const sidebarToggle   = document.getElementById("sidebarToggle");
const sidebarOverlay  = document.getElementById("sidebarOverlay");

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SIDEBAR TOGGLE (mobile)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
sidebarToggle.addEventListener("click", () => {
  sidebar.classList.toggle("open");
  sidebarOverlay.classList.toggle("show");
});

sidebarOverlay.addEventListener("click", () => {
  sidebar.classList.remove("open");
  sidebarOverlay.classList.remove("show");
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTO-RESIZE TEXTAREA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
msgInput.addEventListener("input", () => {
  msgInput.style.height = "auto";
  msgInput.style.height = Math.min(msgInput.scrollHeight, 180) + "px";
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ENTER KEY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
msgInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    handleSend();
  }
});

sendBtn.addEventListener("click", handleSend);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUGGESTION CHIPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sendSuggestion(el) {
  const text = el.innerText.replace(/^[A-Z0-9.]+\s*/, "").trim();
  msgInput.value = text;
  msgInput.dispatchEvent(new Event("input"));
  handleSend();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONVERSATION MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function createConversation(firstMsg) {
  const id    = Date.now().toString();
  const title = firstMsg.length > 40
    ? firstMsg.slice(0, 38) + "â€¦"
    : firstMsg;

  const conv = { id, title, messages: [], created: new Date() };
  conversations.unshift(conv);
  activeConvId = id;
  renderSidebar();
  topbarTitle.textContent = title;
  return conv;
}

function getActiveConv() {
  return conversations.find(c => c.id === activeConvId) || null;
}

function switchConversation(id) {
  activeConvId = id;
  const conv = getActiveConv();
  if (!conv) return;

  topbarTitle.textContent = conv.title;
  renderSidebar();
  renderMessages(conv.messages);

  // Close sidebar on mobile
  sidebar.classList.remove("open");
  sidebarOverlay.classList.remove("show");
}

function deleteConversation(id) {
  conversations = conversations.filter(c => c.id !== id);
  if (activeConvId === id) {
    activeConvId = conversations[0]?.id || null;
    if (activeConvId) {
      switchConversation(activeConvId);
    } else {
      topbarTitle.textContent = "ISO 9001 Quality Assistant";
      clearChatBody();
    }
  }
  renderSidebar();
}

newChatBtn.addEventListener("click", () => {
  activeConvId = null;
  topbarTitle.textContent = "ISO 9001 Quality Assistant";
  clearChatBody();
  renderSidebar();
  msgInput.focus();

  // Close sidebar on mobile
  sidebar.classList.remove("open");
  sidebarOverlay.classList.remove("show");
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER SIDEBAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSidebar() {
  // Remove all items except the empty message
  Array.from(convList.querySelectorAll(".conv-item")).forEach(el => el.remove());

  if (conversations.length === 0) {
    convEmpty.style.display = "block";
    return;
  }

  convEmpty.style.display = "none";

  conversations.forEach(conv => {
    const item = document.createElement("div");
    item.className = "conv-item" + (conv.id === activeConvId ? " active" : "");
    item.dataset.id = conv.id;

    const msgCount = conv.messages.filter(m => m.role === "user").length;
    const timeStr  = formatRelTime(conv.created);

    item.innerHTML = `
      <span class="conv-icon">ğŸ’¬</span>
      <div class="conv-text">
        <div class="conv-title">${escHtml(conv.title)}</div>
        <div class="conv-meta">${msgCount} msg${msgCount !== 1 ? "s" : ""} Â· ${timeStr}</div>
      </div>
      <button class="conv-del" title="Delete">âœ•</button>
    `;

    item.addEventListener("click", (e) => {
      if (e.target.classList.contains("conv-del")) {
        e.stopPropagation();
        deleteConversation(conv.id);
        return;
      }
      switchConversation(conv.id);
    });

    convList.appendChild(item);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER MESSAGES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function clearChatBody() {
  chatBody.innerHTML = "";
  chatBody.appendChild(welcomeScreen);
  welcomeScreen.style.display = "flex";
}

function renderMessages(messages) {
  chatBody.innerHTML = "";

  if (messages.length === 0) {
    chatBody.appendChild(welcomeScreen);
    welcomeScreen.style.display = "flex";
    return;
  }

  messages.forEach(msg => appendMessage(msg.role, msg.content, msg.time, false));
  scrollToBottom();
}

function appendMessage(role, content, time, animate = true) {
  // Hide welcome on first message
  if (welcomeScreen.parentElement === chatBody) {
    welcomeScreen.style.display = "none";
  }

  const group = document.createElement("div");
  group.className = "msg-group";
  if (!animate) group.style.animation = "none";

  const row = document.createElement("div");
  row.className = `msg-row ${role}`;

  const avatar = document.createElement("div");
  avatar.className = `msg-avatar ${role}`;
  avatar.textContent = role === "bot" ? "Q" : "U";

  const msgContent = document.createElement("div");
  msgContent.className = "msg-content";

  const bubble = document.createElement("div");
  bubble.className = "msg-bubble";

  if (role === "bot") {
    bubble.innerHTML = formatBotMessage(content);
  } else {
    bubble.textContent = content;
  }

  const timeEl = document.createElement("div");
  timeEl.className = "msg-time";
  timeEl.textContent = time || formatTime(new Date());

  msgContent.appendChild(bubble);
  msgContent.appendChild(timeEl);
  row.appendChild(avatar);
  row.appendChild(msgContent);
  group.appendChild(row);
  chatBody.appendChild(group);

  if (animate) scrollToBottom();
  return bubble;
}

function appendThinking() {
  const group = document.createElement("div");
  group.className = "msg-group";
  group.id = "thinkingGroup";

  const row = document.createElement("div");
  row.className = "msg-row bot";

  const avatar = document.createElement("div");
  avatar.className = "msg-avatar bot";
  avatar.textContent = "Q";

  const msgContent = document.createElement("div");
  msgContent.className = "msg-content";

  const bubble = document.createElement("div");
  bubble.className = "thinking-bubble";
  bubble.innerHTML = `
    <div class="thinking-dot"></div>
    <div class="thinking-dot"></div>
    <div class="thinking-dot"></div>
  `;

  msgContent.appendChild(bubble);
  row.appendChild(avatar);
  row.appendChild(msgContent);
  group.appendChild(row);
  chatBody.appendChild(group);
  scrollToBottom();
  return group;
}

function removeThinking() {
  const el = document.getElementById("thinkingGroup");
  if (el) el.remove();
}

function formatBotMessage(text) {
  // Highlight ISO clause refs
  return escHtml(text).replace(
    /\b(Clause\s+)?([\d]+\.[\d.]+)\b(?!\s*px)/gi,
    (match) => `<span class="clause">${match}</span>`
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SEND MESSAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function handleSend() {
  const q = msgInput.value.trim();
  if (!q || isLoading) return;

  // Get or create conversation
  let conv = getActiveConv();
  if (!conv) {
    conv = createConversation(q);
  }

  const time = formatTime(new Date());

  // Save user message
  conv.messages.push({ role: "user", content: q, time });
  appendMessage("user", q, time);

  // Reset input
  msgInput.value = "";
  msgInput.style.height = "auto";

  // Show thinking
  const thinkEl = appendThinking();
  setLoading(true);

  try {
    const response = await askQualityBot(q, conv);
    removeThinking();

    const botTime = formatTime(new Date());
    conv.messages.push({ role: "assistant", content: response, time: botTime });
    appendMessage("bot", response, botTime);

    // Update sidebar (message count changed)
    renderSidebar();

  } catch (err) {
    removeThinking();
    const errMsg = `âŒ ${err.message}`;
    const errTime = formatTime(new Date());
    conv.messages.push({ role: "assistant", content: errMsg, time: errTime });
    appendMessage("bot", errMsg, errTime);
    showToast("Request failed. Check the console.");
    console.error(err);
  } finally {
    setLoading(false);
    msgInput.focus();
  }
}

function setLoading(state) {
  isLoading = state;
  sendBtn.classList.toggle("loading", state);
  sendBtn.disabled = state;
  procBar.classList.toggle("show", state);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  API CALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function askQualityBot(question, conv) {
  // Build messages array for multi-turn context
  const messages = [{ role: "system", content: SYSTEM_PROMPT }];

  // Include document context if any
  const contextPrefix = documentContext
    ? `[DOCUMENT CONTEXT]\n${documentContext}\n\n[USER QUESTION]\n`
    : "";

  // Add previous turns (last 10 for context window management)
  const history = conv.messages.slice(-10);
  history.forEach(m => {
    if (m.role === "user") {
      messages.push({ role: "user", content: m.content });
    } else if (m.role === "assistant") {
      messages.push({ role: "assistant", content: m.content });
    }
  });

  // Replace last user message with context-enriched version
  if (contextPrefix && messages.length > 0) {
    const lastUser = [...messages].reverse().find(m => m.role === "user");
    if (lastUser) lastUser.content = contextPrefix + lastUser.content;
  }

  const res = await fetch(`${CONFIG.API_BASE}/api/chat`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ message: question, context: documentContext }),
  });

  if (!res.ok) {
    const errText = await res.text();
    throw new Error(`Server ${res.status}: ${errText}`);
  }

  const data = await res.json();
  return data.response;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DOCUMENT UPLOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
docUploadInput.addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  docUploadPill.classList.add("loaded");
  docUploadLabel.textContent = "Loadingâ€¦";
  procBar.classList.add("show");

  try {
    const text = await extractTextFromFile(file);
    documentContext = text;
    documentName    = file.name;

    const shortName = file.name.length > 18 ? file.name.slice(0, 16) + "â€¦" : file.name;
    docUploadLabel.textContent = shortName;

    // Show context strip and top pill
    ctxStripLabel.textContent = `${file.name} Â· ~${Math.ceil(text.length / 4)} tokens`;
    ctxStrip.classList.add("show");
    docPillLabel.textContent = shortName;
    docPill.classList.remove("hidden");

    showToast(`âœ“ Document loaded: ${file.name}`);
  } catch (err) {
    docUploadPill.classList.remove("loaded");
    docUploadLabel.textContent = "Attach Document";
    showToast(`âŒ ${err.message}`);
  } finally {
    procBar.classList.remove("show");
  }
});

function clearDoc() {
  documentContext = "";
  documentName    = "";
  docUploadLabel.textContent = "Attach Document";
  docUploadInput.value       = "";
  docUploadPill.classList.remove("loaded");
  ctxStrip.classList.remove("show");
  docPill.classList.add("hidden");
  showToast("Document removed.");
}

ctxStripRemove.addEventListener("click", clearDoc);
docPillRemove.addEventListener("click", clearDoc);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILE EXTRACTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function extractTextFromFile(file) {
  const ext = file.name.split(".").pop().toLowerCase();
  if (ext === "txt")  return await file.text();
  if (ext === "pdf")  return await extractPDF(file);
  if (ext === "docx") return await extractDOCX(file);
  throw new Error(`Unsupported file type: .${ext}`);
}

async function extractPDF(file) {
  if (!window.pdfjsLib) {
    await loadScript("https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js");
    window.pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
  }
  const buf = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
  const pages = [];
  for (let i = 1; i <= pdf.numPages; i++) {
    const p  = await pdf.getPage(i);
    const tc = await p.getTextContent();
    pages.push(tc.items.map(s => s.str).join(" "));
  }
  return pages.join("\n\n");
}

async function extractDOCX(file) {
  if (!window.mammoth) {
    await loadScript("https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js");
  }
  const buf    = await file.arrayBuffer();
  const result = await mammoth.extractRawText({ arrayBuffer: buf });
  return result.value;
}

function loadScript(src) {
  return new Promise((res, rej) => {
    if (document.querySelector(`script[src="${src}"]`)) return res();
    const s   = document.createElement("script");
    s.src     = src;
    s.onload  = res;
    s.onerror = () => rej(new Error("Failed to load: " + src));
    document.head.appendChild(s);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BACKEND HEALTH CHECK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener("load", async () => {
  try {
    const res = await fetch(`${CONFIG.API_BASE}/api/health`);
    if (res.ok) {
      showToast("âœ… Connected to server", 2000);
    } else {
      showToast("âŒ Backend not responding", 4000);
    }
  } catch {
    showToast("âŒ Start server: python backend.py", 5000);
  }

  msgInput.focus();
});
</script>
</body>
</html>